<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
  <title>Consulta a servidor</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    #libros div, #versiculos div, #favoritos div {
      margin-bottom: 10px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    button {
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <p class="linea"></p>
  <header class="mostrar-consulta"> 
    <div class="img">
      <img src="./img/Biblia.png" alt="Logo" class="logo">
    </div>
    <h2 class="title">¡Encuentra los versiculos aún más Rápido!</h2>
    <div class="buscador">
      <input type="text" id="busqueda" class="input" placeholder="Buscar Ej: 1,1,1">
      <button onclick="obtenerVersiculo()">Buscar</button>
    </div>
  </header>

  <h1 class="title2">Biblia Reina Valera 1960</h1>
  <section class="container">
    <div id="libros"></div>
    <div id="versiculos" class="caja"></div>
  </section>

  <h2 class="title">Favoritos</h2>
  <section class="container">
    <div id="favoritos"></div>
  </section>

  <script>
    async function obtenerLibros() {
      try {
        const response = await fetch('/api/libro');
        if (!response.ok) {
          throw new Error('Error al obtener los libros');
        }
        const libros = await response.json();
        const librosHTML = libros.map(libro => `
          <div class='content'>
            <h3 class="h3">
              <span>${libro.nombre_libro}</span>
              <span class="id">ID ${libro.id}</span>
            </h3>
            <p>${libro.nombre_moderno}</p>
            <p>${libro.nuevo_testamento ? 'Nuevo Testamento' : 'Antiguo Testamento'}</p>
          </div>
        `).join('');
        document.getElementById('libros').innerHTML = librosHTML;
      } catch (error) {
        console.error(error);
        document.getElementById('libros').innerHTML = 'Error al obtener los libros';
      }
    }

    async function obtenerVersiculo() {
      const valorBusqueda = document.getElementById('busqueda').value;
      const [nombre_libro, libro_id, capitulo, versiculo] = valorBusqueda.split(',');

      console.log(`Consultando libro ID: ${libro_id}, capítulo: ${capitulo}, versículo: ${versiculo}`);
      try {
        const response = await fetch(`/api/versiculo/${libro_id}/capitulo/${capitulo}/versiculo/${versiculo}`);
        if (!response.ok) {
          throw new Error('Error al obtener el versículo');
        }
        const versiculos = await response.json();
        const versiculosHTML = versiculos.map(vers => `
          <div class="mostrar">
            <h4>${nombre_libro} ${vers.capitulo}:${vers.versiculo}</h4>
            <p>${vers.texto}</p>
            <button class="fav-btn" onclick="guardarFavorito(${vers.libro_id}, ${vers.capitulo}, ${vers.versiculo})">Guardar Favorito</button>
          </div>
        `).join('');
        document.getElementById('versiculos').innerHTML = versiculosHTML;
      } catch (error) {
        console.error(error);
        document.getElementById('versiculos').innerHTML = 'Error al obtener el versículo';
      }
    }

    async function guardarFavorito(libro_id, capitulo, versiculo) {
      try {
        const response = await fetch('/api/favorito', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ libro_id: libro_id, capitulo, versiculo })
        });
        const result = await response.json();
        if (!response.ok) {
          throw new Error(result.error || 'Error al guardar el favorito');
        }
        alert('Favorito guardado con éxito');
        obtenerFavoritos();
      } catch (error) {
        console.error(error);
        alert(error.message || 'Error al guardar el favorito');
      }
    }

    async function eliminarFavorito(id) {
      try {
        const url = `/api/favorito/${id}`;
        console.log('URL DELETE:', url); 
        const response = await fetch(url, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          }
        });
      } catch (error) {
      }
    }

    async function obtenerFavoritos() {
      try {
        const response = await fetch('/api/favorito');
        if (!response.ok) {
          throw new Error('Error al obtener los favoritos');
        }
        const favoritos = await response.json();
        const favoritosHTML = favoritos.map(fav => `
          <div>
            <h4>Libro ID: ${fav.libro_id}, Capítulo: ${fav.capitulo}, Versículo: ${fav.versiculo}</h4>
            <button onclick="console.log('Eliminando favorito con ID:', '${fav.id}'); eliminarFavorito('${fav.id}')">Eliminar</button>
          </div>
        `).join('');
        document.getElementById('favoritos').innerHTML = favoritosHTML;
      } catch (error) {
        console.error(error);
        document.getElementById('favoritos').innerHTML = 'Error al obtener los favoritos';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      obtenerLibros();
      obtenerFavoritos();
    });
  </script>
</body>
</html>
